services:
  moltbot:
    build: .
    container_name: moltbot-gateway
    restart: unless-stopped
    ports:
      - "${CLAWDBOT_PORT:-4001}:${CLAWDBOT_PORT:-4001}"
    environment:
      # Required
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      
      # Gateway settings
      - CLAWDBOT_GATEWAY_PORT=${CLAWDBOT_PORT:-4001}
      - CLAWDBOT_GATEWAY_TOKEN=${CLAWDBOT_GATEWAY_TOKEN:-}
      
      # Optional: Telegram
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      
      # Optional: Regenerate config on startup
      - CLAWDBOT_REGENERATE_CONFIG=${CLAWDBOT_REGENERATE_CONFIG:-}
    volumes:
      # Persist workspace and state
      - clawdbot-data:/root/clawd
      - clawdbot-config:/root/.clawdbot
      
      # Optional: Mount custom config
      # - ./config:/config:ro
    networks:
      - moltbot-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${CLAWDBOT_PORT:-4001}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    container_name: moltbot-proxy
    restart: unless-stopped
    ports:
      - "${OAUTH2_PROXY_PORT:-4180}:4180"
    environment:
      - OAUTH2_PROXY_PROVIDER=github
      - OAUTH2_PROXY_CLIENT_ID=${GITHUB_CLIENT_ID}
      - OAUTH2_PROXY_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      - OAUTH2_PROXY_COOKIE_SECRET=${OAUTH2_COOKIE_SECRET}
      - OAUTH2_PROXY_COOKIE_SECURE=true
      - OAUTH2_PROXY_COOKIE_HTTPONLY=true
      - OAUTH2_PROXY_COOKIE_SAMESITE=lax
      - OAUTH2_PROXY_HTTP_ADDRESS=0.0.0.0:4180
      - OAUTH2_PROXY_REDIRECT_URL=${OAUTH2_REDIRECT_URL:-https://bot.vylmio.com/oauth2/callback}
      - OAUTH2_PROXY_EMAIL_DOMAINS=*
      - OAUTH2_PROXY_GITHUB_USER=${GITHUB_ALLOWED_USER:-nineunderground}
      - OAUTH2_PROXY_PASS_HOST_HEADER=true
      - OAUTH2_PROXY_PASS_ACCESS_TOKEN=true
      - OAUTH2_PROXY_SET_XAUTHREQUEST=true
      - OAUTH2_PROXY_PROXY_WEBSOCKETS=true
      - OAUTH2_PROXY_UPSTREAMS=http://moltbot-gateway:${CLAWDBOT_PORT:-4001}/
    networks:
      - moltbot-net
    depends_on:
      moltbot:
        condition: service_healthy
    profiles:
      - oauth2

volumes:
  clawdbot-data:
  clawdbot-config:

networks:
  moltbot-net:
    driver: bridge
